UNAME_S := $(shell uname -s)
NASM := nasm
NASM_FLAGS := -Werror -p$(TOPDIR)/include/macros.asm
MODULE_DIR := $(TOPDIR)/modules
GITVER := $(shell git rev-parse HEAD)
CWD=$(shell pwd)

# The normal swift compiler
SWIFT := swift

# The path to the kernel-lib swift compiler
KSWIFTDIR := /Users/spse/src/swift-project/build/Ninja-DebugAssert/swift-macosx-arm64
#KSWIFTDIR := /Users/spse/Library/Developer/Toolchains/swift-DEVELOPMENT-SNAPSHOT-2024-11-09-a.xctoolchain/usr
KSWIFT := $(KSWIFTDIR)/bin/swift
KSWIFTC := $(KSWIFTDIR)/bin/swiftc
KSWIFTLIBDIR := $(KSWIFTDIR)/lib/swift/embedded/x86_64-unknown-none-elf/
KSWIFTLIBS := 

CC := clang
CFLAGS := -ggdb -Wall -std=gnu11 -Wextra -Werror -target x86_64-unknown-none-elf -ffreestanding -fno-stack-protector -fno-omit-frame-pointer -fno-common -mno-red-zone -mcmodel=kernel  -mno-mmx -mno-sse -mno-sse2 -I$(TOPDIR)/include

ifeq ($(UNAME_S), Linux)
	RUNNER=
	CC=clang
	LD=ld
	OBJCOPY=objcopy
 else
	RUNNER= #docker run --platform linux/amd64  --rm -v $(CWD):$(CWD) -w $(CWD) -t  swift-kstdlib
	CC=clang
	LD=x86_64-elf-ld
	OBJCOPY=x86_64-elf-objcopy
endif

#ifndef USE_FP
#	CFLAGS := $(CFLAGS) -mno-mmx -mno-sse -mno-sse2 -ffreestanding
#	KSWIFTC_FLAGS := $(KSWIFTC_FLAGS) -Xcc -mno-mmx -Xcc -mno-sse -Xcc -mno-sse2 -Xcc -ffreestanding -Xcc -mcmodel=kernel
#endif


ifdef BUILD_ONONE
	KSWIFTC_FLAGS += -Onone
	KSWIFTLIBS += $(KSWIFTLIBDIR)/libswiftSwiftOnoneSupport.a
else
	KSWIFTC_FLAGS +=-Osize -Xcc -O3
	CFLAGS += -O3
endif

NASM_OBJ_FLAGS := -felf64


%.o: %.c
	$(CC) $(CFLAGS) -c -o $@ $<

%.o: %.asm
	$(NASM) $(NASM_FLAGS) $(NASM_OBJ_FLAGS) -o $@ $<

%.bin: %.asm
	$(NASM) $(NASM_FLAGS) -fbin -o $@ $<
