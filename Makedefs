UNAME_S := $(shell uname -s)
NASM := nasm
NASM_FLAGS := -Werror -p$(TOPDIR)/include/macros.asm
MODULE_DIR := $(TOPDIR)/modules
GITVER := $(shell git rev-parse HEAD)
CWD=$(shell pwd)
BUILD_ARCH=$(shell uname -m)

# The normal swift compiler
SWIFT := swift

ifeq ($(UNAME_S), Linux)
    SWIFTDIR := /usr
	RUNNER=
	CC=clang
	LD=x86_64-linux-gnu-ld
	OBJCOPY=x86_64-linux-gnu-objcopy
    PRINTF_MACROS := $(TOPDIR)/macros/Printf/.build/$(BUILD_ARCH)-unknown-linux-gnu/release/PrintfMacros-tool
 else
    SWIFTDIR := ~/Library/Developer/Toolchains/swift-LOCAL-2025-11-20-a.xctoolchain/usr
	RUNNER= #docker run --platform linux/amd64  --rm -v $(CWD):$(CWD) -w $(CWD) -t  swift-kstdlib
	CC=clang
	LD=x86_64-elf-ld
	OBJCOPY=x86_64-elf-objcopy
    PRINTF_MACROS := $(TOPDIR)/macros/Printf/.build/$(BUILD_ARCH)-apple-macosx/release/PrintfMacros-tool
endif

# The path to the kernel-lib swift compiler
SWIFT := $(SWIFTDIR)/bin/swift
SWIFTC := $(SWIFTDIR)/bin/swiftc
SWIFTLIBDIR := $(SWIFTDIR)/lib/swift/embedded/x86_64-unknown-none-elf-kernel/
# See https://github.com/swiftlang/swift/issues/75678 for propper fix (when it is fixed!) for the Unicode Data Tables
SWIFTLIBS := $(SWIFTDIR)/lib/swift/embedded/x86_64-unknown-none-elf-kernel/libswiftUnicodeDataTables.a


CC := clang
CFLAGS := -ggdb -O3 -Wall -std=gnu11 -Wextra -Werror -target x86_64-unknown-none-elf -ffreestanding -fno-stack-protector -fno-omit-frame-pointer -fno-common -mno-red-zone -mcmodel=kernel  -mno-mmx -mno-sse -mno-sse2 -I$(TOPDIR)/include


NASM_OBJ_FLAGS := -felf64


%.o: %.c
	$(CC) $(CFLAGS) -c -o $@ $<

%.o: %.asm
	$(NASM) $(NASM_FLAGS) $(NASM_OBJ_FLAGS) -o $@ $<

%.bin: %.asm
	$(NASM) $(NASM_FLAGS) -fbin -o $@ $<
